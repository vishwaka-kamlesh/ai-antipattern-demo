rules:

  # 1. Truly empty catch blocks (ignores comments, braces, TODOs)
  - id: empty-catch-block
    languages: [java]
    severity: ERROR
    message: Empty catch block swallows exceptions. At minimum log or rethrow.
    pattern: |
      catch ($EX $E) { }

  # 2. printStackTrace() — zero tolerance
  - id: no-print-stacktrace
    languages: [java]
    severity: ERROR
    message: Never use printStackTrace(). Use logger.error("...", e) instead.
    pattern: |
      $E.printStackTrace(...)

  # 3. System.out / System.err — any method call
  - id: no-system-out
    languages: [java]
    severity: ERROR
    message: Use SLF4J logger instead of System.out/err.
    pattern-either:
      - pattern: System.out.$ANY(...)
      - pattern: System.err.$ANY(...)

  # 4. Logging sensitive data — very tight, zero false positives
  - id: logging-sensitive-data
    languages: [java]
    severity: ERROR
    message: Logging sensitive data (password, token, card, PAN, phone, email). Mask before logging.
    pattern-regex: |
      logger\.(trace|debug|info|warn|error)\s*\(.*\b(password|passwd|pwd|token|secret|cardNumber|card_number|pan|mobile|phone|email|cvv|expiry)\b.*\)

  # 5. Hardcoded credentials — catches only real secrets ≥8 chars
  - id: hardcoded-credentials
    languages: [java]
    severity: ERROR
    message: Hardcoded secret detected. Move to Vault / Config / Secrets Manager.
    pattern-regex: |
      (?i)(password|passwd|pwd|secret|token|api[_-]?key|client[_-]?secret|bearer)\s*[:=]\s*"[^"{}\s]{8,}"

  # 6. Hardcoded URLs — excludes common false positives
  - id: hardcoded-url
    languages: [java]
    severity: ERROR
    message: Hardcoded URL. Move to @Value or application.yml.
    pattern-regex: |
      "https?://(?!schemas\.android\.com|localhost|127\.0\.0\.1|0\.0\.0\.0)[a-zA-Z0-9_.-]+
    # Excludes XML schemas and local dev URLs

  # 7. SQL string concatenation — only when building actual queries
  - id: sql-concat
    languages: [java]
    severity: ERROR
    message: SQL string concatenation → SQL injection risk. Use QueryDSL or parameters.
    patterns:
      - pattern-either:
          - pattern: "$Q + $V"
          - pattern: "$Q += $V"
      - metavariable-pattern:
          metavariable: $Q
          pattern-regex: "(?i)(select|insert|update|delete|from|where|order by|group by)"

  # 8. Thread.sleep — allowed only in test packages
  - id: no-thread-sleep
    languages: [java]
    severity: ERROR
    message: Thread.sleep() blocks container threads. Use Testcontainers wait strategies or ScheduledExecutor.
    patterns:
      - pattern: Thread.sleep(...)
      - pattern-not-inside: |
          package ...test;
          ...

  # 9. String concatenation in loop — precise
  - id: concat-in-loop
    languages: [java]
    severity: ERROR
    message: String concatenation in loop creates many temporary objects. Use StringBuilder or collect + join.
    pattern-either:
      - pattern-inside: |
          for ($T $V : $COL) { ... }
          $S += $X;
      - pattern-inside: |
          while (...) { ... }
          $S += $X;

  # 10. Object creation in loop — ignores common safe cases
  - id: object-in-loop
    languages: [java]
    severity: WARNING
    message: Object creation inside loop. Consider moving outside if possible.
    patterns:
      - pattern-inside: |
          for (...) { ... }
          new $TYPE(...);
      - pattern-not: new StringBuilder(...)
      - pattern-not: new ArrayList<>()

  # 11. N+1 query heuristic — only repository/JdbcTemplate calls
  - id: nplus1-query
    languages: [java]
    severity: ERROR
    message: Potential N+1 query: database call inside loop.
    patterns:
      - pattern-inside: |
          for (...) { ... }
          $REPO.$METHOD(...);
      - metavariable-pattern:
          metavariable: $REPO
          pattern-either:
            - pattern-regex: ".*Repository"
            - pattern-regex: ".*Repo"
            - pattern: $JDBC

  # 12. String == comparison — type-safe
  - id: string-eq-operator
    languages: [java]
    severity: ERROR
    message: Use .equals() for String comparison, not ==.
    pattern: |
      $X == $Y
    metavariable-type:
      $X: java.lang.String
      $Y: java.lang.String

  # 13. DTO public fields — only in classes named DTO/Spec/Request/Response
  - id: dto-non-private-field
    languages: [java]
    severity: ERROR
    message: DTO fields must be private. Use getters/setters or records.
    patterns:
      - pattern: public $T $FIELD;
      - pattern-inside: |
          class $NAME ... { ... }
      - metavariable-pattern:
          metavariable: $NAME
          pattern-regex: "(?i)(DTO|Request|Response|Spec|VO)$"

  # 14. Unused imports — let Semgrep handle natively (no pattern needed)
  - id: unused-import
    languages: [java]
    severity: WARNING
    message: Remove unused import.
    pattern: |
      import $IMPL;

  # 15. Magic numbers — excludes 0, 1, -1, 2–10 in common contexts
  - id: magic-number
    languages: [java]
    severity: WARNING
    message: Replace magic number with named constant.
    pattern-either:
      - pattern: $X = $N;
      - pattern: return $N;
      - pattern: $N$OP
    metavariable-pattern:
      metavariable: $N
      pattern-regex: ^(1[1-9]|[2-9][0-9]+|[1-9][0-9]{2,})$  # 11 and above

  # 16. Field injection — allows @Value, blocks @Autowired
  - id: no-field-autowired
    languages: [java]
    severity: ERROR
    message: Field injection with @Autowired is banned. Use constructor injection.
    patterns:
      - pattern: |
          @Autowired
          $MODIFIER $TYPE $FIELD;
      - pattern-not: |
          @Value
